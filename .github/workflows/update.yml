name: Update

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Update Openclash Master
        run: |
          git clone --depth 1 -b master https://github.com/vernesong/OpenClash.git temp_master
          rsync -av --exclude='.git' --exclude-from=.syncignore temp_master/ "OpenClash-master/"
          rm -rf temp_master
          rm -rf "OpenClash-master/.github"
          rm -f "OpenClash-master/LICENSE"
          rm -f "OpenClash-master/README.md"
          git add "OpenClash-master"
          git commit -m "Sync master" || echo "No changes to commit"

      - name: Update Openclash dev
        run: |
          git clone --depth 1 -b dev https://github.com/vernesong/OpenClash.git temp_dev
          rsync -av --exclude='.git' --exclude-from=.syncignore temp_dev/ "OpenClash-dev/"
          rm -rf temp_dev
          rm -rf "OpenClash-dev/.github"
          rm -f "OpenClash-dev/LICENSE"
          rm -f "OpenClash-dev/README.md"
          git add "OpenClash-dev"
          git commit -m "Sync dev" || echo "No changes to commit"

      - name: Push changes
        run: git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_GITHUB }}

      - name: Update version
        run: |
          if [ -f "Openclash stable/luci-app-openclash/Makefile" ]; then
            MAKEFILE_VERSION=$(grep 'PKG_VERSION:=' "Openclash stable/luci-app-openclash/Makefile" | cut -d'=' -f2)
            sed -i "s/versi: .*/versi: $MAKEFILE_VERSION/" README.md
            git add README.md
            git commit -m "Update TO $MAKEFILE_VERSION" || echo "No version changes to commit"
            git push origin main
          else
            echo "Makefile not found"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_GITHUB }}
